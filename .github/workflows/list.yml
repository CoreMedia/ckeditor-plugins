name: "List Packages"

on:
  workflow_dispatch:
  workflow_call:

permissions: {}

jobs:
  env:
    uses: "./.github/workflows/env.yml"
  authorize:
    name: "Authorize"
    runs-on: ubuntu-latest
    needs:
      - env
    env:
      NPM_HOST: ${{ needs.env.outputs.npm-host }}
      NPM_URL: ${{ needs.env.outputs.npm-url }}
    outputs:
      npm-auth-token: ${{ steps.npm-auth.outputs.token }}
    steps:
      - id: npm-auth
        name: "NPM Authorization"
        run: |
          result=$(curl -s -H "Accept: application/json" -H "Content-Type:application/json" -X PUT --data '{"name": "${{ secrets.CM_NPM_USER }}", "password": "${{ secrets.CM_NPM_PASSWORD }}"}' "${{ env.NPM_URL }}/-/user/org.couchdb.user:${{ secrets.CM_NPM_USER }}" | jq -r .token)
          # Ensure, the token is not exposed in output.
          echo "::add-mask::${result}"
          echo "token=${result}" >> $GITHUB_OUTPUT
  main:
    name: "Main"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    needs:
      - env
      - authorize
    env:
      NPM_HOST: ${{ needs.env.outputs.npm-host }}
      NPM_URL: ${{ needs.env.outputs.npm-url }}
      NPM_AUTH_TOKEN: ${{ needs.authorize.outputs.npm-auth-token }}
    steps:
      - id: checkout
        name: 'Init: Checkout'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: false
      - id: npmrc
        name: "Init: .npmrc"
        run: |
          npmHost="${{ env.NPM_HOST }}"
          npmUrl="${{ env.NPM_URL }}"
          npmAuthToken="${{ env.NPM_AUTH_TOKEN }}"

          echo "//${npmHost}/:_authToken=${npmAuthToken}" >> .npmrc
          echo "@coremedia:registry=${npmUrl}" >> .npmrc
          # We must not commit this change.
          git update-index --assume-unchanged .npmrc
      - id: list-coremedia-ckeditor
        name: "List: @coremedia/ckeditor*"
        run: |
          npmHost="${{ env.NPM_HOST }}"
          packages=$(npm search "@coremedia/ckeditor" --json --registry "${npmHost}")

          echo "# \`@coremedia/ckeditor*\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Package |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|" >> $GITHUB_STEP_SUMMARY

          for package in $(jq -r ".[].name" <(echo "${packages}")); do
            echo "${package}"
            echo "| \`${package}\` |" >> $GITHUB_STEP_SUMMARY
            npm view "${package}" versions --registry "${npmHost}"
          done
      - id: list-coremedia-ckeditor-types
        name: "List: @coremedia/types-ckeditor* (Deprecated)"
        run: |
          npmHost="${{ env.NPM_HOST }}"
          packages=$(npm search "@coremedia/types-ckeditor__" --json --registry "${npmHost}")

          echo "# \`@coremedia/types-ckeditor__*\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Former manual typings prior to CKEditor 5 TypeScript release."
          echo ""
          echo "| Package |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|" >> $GITHUB_STEP_SUMMARY

          for package in $(jq -r ".[].name" <(echo "${packages}")); do
            echo "${package}"
            echo "| \`${package}\` |" >> $GITHUB_STEP_SUMMARY
            npm view "${package}" versions --registry "${npmHost}"
          done
