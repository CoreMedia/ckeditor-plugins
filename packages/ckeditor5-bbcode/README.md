# CoreMedia BBCode Plugin

[![API Documentation][docs:api:badge]][docs:api]

[docs:api]: <https://coremedia.github.io/ckeditor-plugins/docs/api/modules/ckeditor5_bbcode.html> "@coremedia/ckeditor5-bbcode"
[docs:api:badge]: <https://img.shields.io/badge/docs-%F0%9F%93%83%20API-informational?style=for-the-badge>

**Module:** `@coremedia/ckeditor5-bbcode`

This module provides a data-processor for BBCode, thus, applies a mapping
from the CKEditor 5 data view (HTML) to BBCode data and vice versa.

For the `toView` (_to Data View_) mapping, processing is based on [BBob][]
with some recommended configuration options applied.

The `toData` mapping is a proprietary implementation, which provides a slightly
richer configuration API.

## Limitations

This plugin does not expose the configuration API of [BBob][] and as such,
adaptations to the configuration are rather limited.

For example, it is impossible to adapt the code block language mapping in
`toView` processing. Instead, the given configuration assumes the default
behavior of the CKEditor 5 Code Block plugin, which is, that all languages
chosen are denoted by a class pattern `language-<code block language>`.

For security reasons, [BBob][] is configured with a strict allowlist regarding
supported BBCode tags. This allowlist is autogenerated via the (configurable)
`toData` mapping rules. Any other tags will be escaped in `toView` processing:

```text
[unknown]Text[/unknown]
```

will become

```text
\[unknown\]Text\[/unknown\]
```

## Extension Points

As sketched, there is a minor extension point to add new `toData` rules. This
implicitly also has a minor impact on the `toView` processing, as it will allow
the configured `tags`. These, by default, will be forwarded as 1:1 mapping from
BBCode to HTML, thus, the example `[unknown]` above, will become `<unknown>`
in data view, if you mark it as supported. It is up to you, then, to provide
a corresponding data-upcast to the model layer if this does not already
represent a well-known HTML tag by CKEditor 5.

### `toData` Rules Implementation Notes

#### Rule Override

TODO (implement) override defaults by ID

#### Return: Undefined Or String?

When it comes to implementing rules, a repeating question is, if to return
`undefined` or a string.

**The rule of thumb is to only return a string if a rule provides _relevant_
content.**

This is best explained by example:

The default _Bold_ processing detects the bold-state by element name or
corresponding style declarations. When it detects, that the element content
shall be rendered as bold, it will return `[b]<content>[/b]`.

But if it is not applicable, or bold state got vetoed like in
`<strong style="font-weight:normal;">`, it will return `undefined` and just
modify the processed element state to denote, that the `fontWeight` already
got processed.

## Supported BBCode

The BBCode to HTML processing is essentially based on [BBob][] and a slightly
customized HTML5 Preset. The allowed tags are limited be the assigned
`toData` processing rules (`tags` configuration).

In the following, you will find the supported BBCode tags and how they best
integrate with CKEditor 5.

### Escaping

While there is no standard escape mechanism for BBCode, the plugin is based
on the most often used backslash-escaping syntax, that is also supported by
[BBob][]. Thus, the following will provide valid BBCode that can be
processed by this plugin in `toView` and `toData` mapping:

```text
[code=bbcode]
\[b\]Bold Example\[/b\]
[/code]
```

### Paragraphs

Paragraphs are implicitly given by an additional newline:

```text
Paragraph 1.

Paragraph 2.
```

#### CKEditor 5 Integration

Requires the
[CKEditor 5 Paragraph Feature](https://ckeditor.com/docs/ckeditor5/latest/api/paragraph.html)
to be enabled.

### Headings

Heading levels one to six are supported by BBCode tags:

| Tag    | as HTML |
|--------|---------|
| `[h1]` | `<h1>`  |
| `[h2]` | `<h2>`  |
| `[h3]` | `<h3>`  |
| `[h4]` | `<h4>`  |
| `[h5]` | `<h5>`  |
| `[h6]` | `<h6>`  |

#### CKEditor 5 Integration

Requires the
[CKEditor 5 Headings Feature](https://ckeditor.com/docs/ckeditor5/latest/features/headings.html)
to be enabled.

Note that by default the Headings feature does not allow selecting heading
level 1. Processing assumes, that you enabled `<h1>` as valid, supported
element.

### Basic Text Style: Bold

Relying on the HTML5 Preset by [BBob][] the `toView` mapping is as follows:

| Tag   | as HTML                             |
|-------|-------------------------------------|
| `[b]` | `<span style="font-weight: bold;">` |

This is well understood by the Bold plugin of CKEditor 5. The `toData`
transformation will accept the above representation as well as the default
representation `<strong>Text</strong>` and will map them back to `[b]` again.

#### CKEditor 5 Integration

Requires the
[CKEditor 5 Bold Feature](https://ckeditor.com/docs/ckeditor5/latest/api/module_basic-styles_bold-Bold.html)
to be enabled.

### Basic Text Style: Italic

Relying on the HTML5 Preset by [BBob][] the `toView` mapping is as follows:

| Tag   | as HTML                              |
|-------|--------------------------------------|
| `[i]` | `<span style="font-style: italic;">` |

This is well understood by the CKEditor 5 Italic plugin. The `toData`
transformation will accept the above representation as well as the default
representation `<i>Text</i>` and will map them back to `[i]` again.

#### CKEditor 5 Integration

Requires the
[CKEditor 5 Italic Feature](https://ckeditor.com/docs/ckeditor5/latest/api/module_basic-styles_italic-Italic.html)
to be enabled.

### Basic Text Style: Underline

Relying on the HTML5 Preset by [BBob][] the `toView` mapping is as follows:

| Tag   | as HTML                                      |
|-------|----------------------------------------------|
| `[u]` | `<span style="text-decoration: underline;">` |

This is well understood by the CKEditor 5 Strikethrough plugin. The `toData`
transformation will accept the above representation as well as the default
representation `<u>Text</u>` and will map them back to `[u]` again.

Further supported element in data-view representation, that will be mapped
to `[u]`:

* `<ins>`

#### CKEditor 5 Integration

Requires the
[CKEditor 5 Underline Feature](https://ckeditor.com/docs/ckeditor5/latest/api/module_basic-styles_underline-Underline.html)
to be enabled.

### Basic Text Style: Strikethrough

Relying on the HTML5 Preset by [BBob][] the `toView` mapping is as follows:

| Tag   | as HTML                                         |
|-------|-------------------------------------------------|
| `[s]` | `<span style="text-decoration: line-through;">` |

This is well understood by the CKEditor 5 Strikethrough plugin. The `toData`
transformation will accept the above representation as well as the default
representation `<s>Text</s>` and will map them back to `[s]` again.

Further supported elements in data-view representation, that will be mapped
to `[s]`:

* `<strike>` (deprecated tag)
* `<del>`

#### CKEditor 5 Integration

Requires the
[CKEditor 5 Strikethrough Feature](https://ckeditor.com/docs/ckeditor5/latest/api/module_basic-styles_strikethrough-Strikethrough.html)
to be enabled.

### Font Color

Relying on the HTML5 Preset by [BBob][] the `toView` mapping is as follows:

| Tag                 | as HTML                            |
|---------------------|------------------------------------|
| `[color=#ff0000]`   | `<span style="color: #ff0000;">`   |
| `[color=#ff0000a0]` | `<span style="color: #ff0000a0;">` |

#### CKEditor 5 Integration

Requires the
[CKEditor 5 FontColor Feature](https://ckeditor.com/docs/ckeditor5/latest/api/module_font_fontcolor-FontColor.html)
to be enabled.

A possible recommended configuration for the CKEditor 5 font-color feature to
support this, is:

```text
fontColor: {
  colors: [
    {
      color: "#000000",
      label: "Black",
    },
    {
      color: "red",
      label: "Red",
    },
    {
      color: "rgba(0, 0, 255, 1.0)",
      label: "Blue",
    },
  ],
  colorPicker: {
    format: "hex",
  },
},
```

Formats such as HSL, RGB are supported in `toData` mapping. They will be
transparently transformed to the corresponding hex/hex-alpha codes suitable
for the `[color]` tag.

### Links

Relying on the HTML5 Preset by [BBob][] the `toView` mapping is as follows:

| Tag                      | as HTML                  |
|--------------------------|--------------------------|
| `[url=https://...]`      | `<a href="https://...">` |
| `[url]https://...[/url]` | `<a href="https://...">` |

In favor of shortened BBCode, also the `toData` processing uses the short
notion for URL if text content and URL are strictly equal.

**Escaping:** In case, the URL contains characters `[` or `]`, they will be
encoded to the URL encoded form in `toData` processing.

#### CKEditor 5 Integration

Requires the
[CKEditor 5 Link Feature](https://ckeditor.com/docs/ckeditor5/latest/api/link.html)
to be enabled.

#### Relative URLs

Relative URLs are passed as is to the data view without any further
intervention, assuming, that they should stay relative also during editorial
actions.

Nevertheless, consider that relative links edited in a different context they
were written for or written at, may contain invalid links when clicked.
This is true for the CKEditor 5 Contextual Link Balloon, as well as for a
read-only view.

### Images

The BBCode Plugin supports images in BBCode along with an `alt` attribute
as supported by some BBCode parsers:

| Tag                                | as HTML                             |
|------------------------------------|-------------------------------------|
| `[img]https://...[/img]`           | `<img src="https://...">`           |
| `[img alt="ALT"]https://...[/img]` | `<img alt="ALT" src="https://...">` |

**Escaping:** In case, the URL contains characters `[` or `]`, they will be
encoded to the URL encoded form in `toData` processing.

Similar, square brackets within the attribute are encoded to HTML numeric
entities, as this has shown the best robustness among various BBCode parsers.
Nevertheless, this assumes, that BBCode is always rendered to HTML or some
other entity-supporting representation.

#### CKEditor 5 Integration

Requires the following
[CKEditor 5 Image Feature](https://ckeditor.com/docs/ckeditor5/latest/api/image.html)
to be enabled.

Due to several setup options, the following setup has proven to align best
with BBCode support:

* **Recommended Plugins:**

  * [ImageInline](https://ckeditor.com/docs/ckeditor5/latest/api/module_image_imageinline-ImageInline.html)

    In general, BBCode parsers expect `[img]` to be represented as inline
    object. The glue plugin also automatically includes `alt` attribute
    support.

  * [ImageToolbar](https://ckeditor.com/docs/ckeditor5/latest/api/module_image_imagetoolbar-ImageToolbar.html)

    Required to be able to edit the `alt` attribute. Ensure to enable
    `imageTextAlternative` as `image.toolbar` option.

  * [LinkImage](https://ckeditor.com/docs/ckeditor5/latest/api/module_link_linkimage-LinkImage.html)

    Requires `ImageBlockEditing` to be installed.

### Code Blocks

The BBCode Plugin ships with an adapted transformation compared to the
original HTML5 Preset by [BBob][]:

| Tag      | as HTML                                  |
|----------|------------------------------------------|
| `[code]` | `<pre><code class="language-plaintext">` |

The adapted mapping ensures that it integrates effortless with CKEditor 5
Code Block editing feature.

Also, the optional language information is transformed expecting the default
behavior of the Code Block editing feature adding a `class` entry prefixed
with `language-` to the nested `<code>` element.

Thus, with adaptations applied, the language-aware mapping is as follows:

| Tag           | as HTML                             |
|---------------|-------------------------------------|
| `[code=html]` | `<pre><code class="language-html">` |

This works as bijective mapping in both directions.

#### CKEditor 5 Integration

Requires the
[CKEditor 5 Code Blocks Feature](https://ckeditor.com/docs/ckeditor5/latest/features/code-blocks.html)
to be enabled.

### Blockquotes

Relying on the HTML5 Preset by [BBob][] the `toView` mapping is as follows:

| Tag       | as HTML           |
|-----------|-------------------|
| `[quote]` | `<blockquote><p>` |

The `toData` transformation provides a bijective mapping of the above.

Note that there is no mapping for the optional author-argument that may be
set in BBCode. Thus, any applied author information will be lost.

#### CKEditor 5 Integration

Requires the
[CKEditor 5 Block Quote Feature](https://ckeditor.com/docs/ckeditor5/latest/features/block-quote.html)
to be enabled.

### Document Lists

Relying on the HTML5 Preset by [BBob][] the `toView` mapping is as follows:

| Tag        | as HTML         |
|------------|-----------------|
| `[list]`   | `<ul>`          |
| `[list=1]` | `<ol>`          |
| `[list=a]` | `<ol type="a">` |
| `[*]`      | `<li>`          |

#### CKEditor 5 Integration

Requires the
[CKEditor 5 Document Lists Feature](https://ckeditor.com/docs/ckeditor5/latest/features/lists/document-lists.html)
to be enabled.

For the best support, you should configure the Document List Feature of
CKEditor 5 as follows:

```text
list: {
  properties: {
    startIndex: false,
    styles: {
      useAttribute: true,
    },
    reversed: false,
  },
},
```

The `useAttribute` flag will signal, that the `<ol>` `type` attribute is used.

**CSS Limitation:** Unless browsers support the CSS Working Group Draft
[2101](https://github.com/w3c/csswg-drafts/issues/2101) with case-sensitive
selectors, you cannot distinguish in styling between `i` and `I` or `a`
and `A`. The rendered BBCode, though, will respect the different cases.

### Tables (Limited Support)

Relying on the HTML5 Preset by [BBob][] the `toView` mapping is as follows:

| Tag        | as HTML         |
|------------|-----------------|
| `[table]`  | `<table>`       |
| `[thead]`  | `<thead>`       |
| `[tbody]`  | `<tbody>`       |
| `[tr]`     | `<tr>`          |
| `[td]`     | `<td>`          |
| `[th]`     | `<th>`          |

As, for example, cells spanning multiple columns are not supported, the
recommended configuration for the CKEditor 5 table feature is:

```text
table: {
  contentToolbar: ["tableColumn", "tableRow"],
},
```

**Limitation:** Note that mapping by [BBob][] to HTML is a rather simple
1:1 mapping of BBCode tag to HTML tag. Having this, it does not respect, for
example, the requirement, that a heading column must be placed into a `thead`
section. Otherwise, the layout in CKEditor 5 will break.

Thus, to make a table with `[th]` entries work in CKEditor 5 regarding the
column and row headers, the BBCode must be as follows:

```text
[table]
  [thead]
    [tr]
      [th]Head C/R[/th]
      [th]Head R[/th]
    [/tr]
  [/thead]
  [tbody]
    [tr]
      [th]Head C[/th]
      [td]Data[/td]
    [/tr]
  [/tbody]
[/table]
```

### Data Facade

If you want to prevent unchanged data (thus, without editorial actions applied)
to be written back to some backend that stores BBCode, you may want to use the
CKEditor 5 Data Facade plugin. This will, for example, prevent re-ordering of
inline style tags:

```text
[b][i]bold, italic[/i][/b]
```

may as well be rendered in `toData` processing as:

```text
[i][b]bold, italic[/b][/i]
```

Similarly, the data facade will prevent accidentally applied escaping to
unknown tags to be written back to server. Without data facade, assume the
following BBCode with some vendor-specific tag:

```text
[spoiler]Don't tell![/spoiler]
```

This will be written back as:

```text
\[spoiler\]Don't tell!\[/spoiler\]
```

With the Data Facade plugin enabled will only be written on editorial actions.

### Unsupported BBCode Tags

Yet unsupported BBCode tags (among several vendor-specific ones) are:

* `[style]`

## Security Considerations

When it comes to parsing and transforming BBCode to HTML, you have to expect,
that BBCode comes from _untrusted_ sources, such as comments on a web page.

The BBCode plugin takes care of possible attack vectors regarding proper
escaping on `toView` (BBCode to HTML) as well as in `toData` (HTML to BBCode)
processing. This is ensured, for example, by using DOM API to set attributes
in HTML rather than naive string concatenation.

**But:** The BBCode does not filter any possibly malicious data on other layers.

Some example scenarios:

* An attacker creates BBCode such as `[h1 onclick='...']`.

  The BBCode plugin, powered by BBob, will transform this into
  `<h1 onclick="...">` without further checks. It is up to the editing layer,
  to deal with this possibly malicious code.

  CKEditor 5 ships with "default security enabled" feature, which is, that
  any unknown attributes are just stripped and never make it to the editors'
  view.

  Care must be taken, not to enable these attributes/states by accident, either
  by allowing `on*` handlers by a corresponding plugin or by improper
  configuration of the General HTML Support (GHS) plugin, e.g., by using the
  wildcard configuration: _any HTML is considered valid_.

* An attacker tricks editors by malicious URLs in `[url=...]`.

  Again, the BBCode plugin will not apply any filter here and trusts the
  editing layer to handle possibly dangerous links with care. This is known
  to work for current CKEditor 5 versions in that way, that any protocols
  not on the allow-list (as of now, https, http, ftp, ftps and mailto) will
  create links in the CKEditor 5 editing UI, that are sanitized (but can
  still be edited).

  Nevertheless, there is no additional filter on data-processing layer, that,
  for example, removes URLs to malicious websites, as modifying data should be
  a clear conscious editorial action. 

## See Also

* [BBCode - Wikipedia](https://en.wikipedia.org/wiki/BBCode)
* [BBCode.org, BBCode users guide and tricks on web2 and web3](https://www.bbcode.org/)
* [JiLiZART/BBob][BBob]

[BBob]: <https://github.com/JiLiZART/BBob> "JiLiZART/BBob"
